name: Deploy

on:
  push:
    tags:
      - "v*"

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc  # Dynamically use the version from .nvmrc

      - run: npm ci

      - run: npm run build

      - name: Prepare deploy folder
        run: |
          mkdir deploy
          cp -r dist/* deploy/
          cp package.json deploy/
          cp README.md deploy/
          cd deploy
          # Rewrite package.json for dist branch layout
          node - << 'NODE'
          const fs = require('fs');

          const pkgPath = 'package.json';
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

          // Adjust entrypoints for root layout
          pkg.main = 'index.js';
          pkg.types = 'index.d.ts';

          // Only ship built artifacts
          pkg.files = ['core/**/*', 'index.*', 'README.md'];

          // Clean dev-only fields
          delete pkg.scripts;
          delete pkg.devDependencies;

          // Proper exports map for bundlers/TypeScript
          pkg.exports = {
            '.': {
              types: './index.d.ts',
              import: './index.js',
            },
          };

          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
          NODE

      - name: Push dist branch and tag for this release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG_NAME: ${{ github.ref_name }}      # e.g. v0.1.5
          REPO: ${{ github.repository }}        # e.g. canida-software/style-forge
        run: |
          cd deploy

          # Init a tiny one-branch repo containing only the built artifacts
          git init
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add .
          git commit -m "build: ${TAG_NAME}"

          # Keep 'dist' as the moving latest-build branch
          git branch -M dist

          # Create an immutable tag for this build
          DIST_TAG="dist-${TAG_NAME}"           # e.g. dist-v0.1.5
          git tag "${DIST_TAG}"

          # Push branch and tag to the main repo
          git remote add origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${REPO}.git"
          git push --force origin dist
          git push origin "${DIST_TAG}"
