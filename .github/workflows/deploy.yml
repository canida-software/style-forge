name: Deploy

on:
  push:
    tags:
      - "v*"

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    needs: ci
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version-file: .nvmrc  # Dynamically use the version from .nvmrc

      - run: npm ci

      - run: npm run build

      - name: Prepare deploy folder
        run: |
          mkdir deploy
          cp -r dist/* deploy/
          cp package.json deploy/
          cp README.md deploy/
          cd deploy
          # Rewrite package.json for dist branch layout
          node - << 'NODE'
          const fs = require('fs');

          const pkgPath = 'package.json';
          const pkg = JSON.parse(fs.readFileSync(pkgPath, 'utf8'));

          // Adjust entrypoints for root layout
          pkg.main = 'index.js';
          pkg.types = 'index.d.ts';

          // Only ship built artifacts
          pkg.files = ['core/**/*', 'index.*', 'README.md'];

          // Clean dev-only fields
          delete pkg.scripts;
          delete pkg.devDependencies;

          // Proper exports map for bundlers/TypeScript
          pkg.exports = {
            '.': {
              types: './index.d.ts',
              import: './index.js',
            },
          };

          fs.writeFileSync(pkgPath, JSON.stringify(pkg, null, 2));
          NODE

      - name: Deploy to dist branch
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy
          branch: dist
          clean: true
